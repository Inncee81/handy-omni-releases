// ==UserScript==
// @name         Handy script player
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  play funscripts on most websites
// @author       You
// @match        https://*/*
// @match        http://*/*
// @inject-into  auto
// @grant        GM_getValue
// @grant        GM_setValue
// ==/UserScript==

!function(e){var t={};function n(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(i,o,function(t){return e[t]}.bind(null,o));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}([function(e,t,n){"use strict";var i,o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.changeCurrentlyPlaying=t.stateChange=t.changeTimeOffset=t.changeHandyIdState=t.changeScript=t.changeVideoElement=t.registerStateListener=t.changeState=t.state=t.STATES=void 0,function(e){e.INIT="init",e.SELECT_VIDEO_ELEMENT="select_video_element",e.SELECT_SCRIPT="select_script",e.UPLOADING_SCRIPT="uploading_script",e.INPUT_HANDY_ID="input_handy_id",e.CONNECTING_HANDY="connecting_handy",e.CONNECTED_HANDY="connected_handy",e.DOWNLOADING_TO_HANDY="downloading_to_handy",e.DETERMINING_DELAY="determining_delay",e.READY="ready",e.PLAYING="playing",e.PAUSED="paused"}(i=t.STATES||(t.STATES={})),t.state={type:i.INIT,timeOffset:0,hidden:!0,playing:!1},t.changeState=function(e){var n=o({},t.state);t.state=e,null==a||a.onState(n,e)};var a=null;t.registerStateListener=function(e){a=e},t.changeVideoElement=function(e){var n=o({},t.state);n.videoElement=e,t.changeState(n)},t.changeScript=function(e){var n=o({},t.state);n.script=e,t.changeState(n)},t.changeHandyIdState=function(e){var n=o({},t.state);n.handyId=e,t.changeState(n)},t.changeTimeOffset=function(e){var n=o({},t.state);n.timeOffset=e,t.changeState(n)},t.stateChange=function(e){var n=o({},t.state);n.type=e,t.changeState(n)},t.changeCurrentlyPlaying=function(e){var n=o({},t.state);n.playing=e,t.changeState(n)}},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,a){function r(e){try{l(i.next(e))}catch(e){a(e)}}function s(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,s)}l((i=i.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,i,o,a,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(o=2&a[0]?i.return:a[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,a[1])).done)return o;switch(i=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,i=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(o=r.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){r=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){r.label=a[1];break}if(6===a[0]&&r.label<o[1]){r.label=o[1],o=a;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(a);break}o[2]&&r.ops.pop(),r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e],i=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}};Object.defineProperty(t,"__esModule",{value:!0});var a=n(0),r=function(){function e(){}return e.getStatus=function(e){return void 0!==e?this.makeRequest("GET","https://www.handyfeeling.com/api/v1/"+e+"/getStatus"):this.makeRequest("GET","https://www.handyfeeling.com/api/v1/"+a.state.handyId+"/getStatus")},e.calculateDelay=function(){return i(this,void 0,void 0,(function(){var e,t,n,i,r,s;return o(this,(function(l){switch(l.label){case 0:e=10,t="https://www.handyfeeling.com/api/v1/"+a.state.handyId+"/getServerTime",n=0,i=function(e){var i;return o(this,(function(e){switch(e.label){case 0:return i=Date.now(),[4,r.makeRequest("GET",t).then((function(e){var t=Date.now(),o=t-i,a=e.serverTime+o/2-t;console.log(a),n+=a}))];case 1:return e.sent(),[2]}}))},r=this,s=0,l.label=1;case 1:return s<e?[5,i(s)]:[3,4];case 2:l.sent(),l.label=3;case 3:return s++,[3,1];case 4:return[2,n/e]}}))}))},e.uploadFunscript=function(e){var t=new FormData;return t.append("syncFile",e),this.makeRequest("POST","https://www.handyfeeling.com/api/sync/upload",t,!1)},e.prepareScriptSync=function(){var e,t;return this.makeRequest("GET","https://www.handyfeeling.com/api/v1/"+a.state.handyId+"/syncPrepare?url="+(null===(e=a.state.script)||void 0===e?void 0:e.url)+"&size="+(null===(t=a.state.script)||void 0===t?void 0:t.size)+"&timeout=20000")},e.playScript=function(){this.makeRequest("GET","https://www.handyfeeling.com/api/v1/"+a.state.handyId+"/syncPlay?play=true&serverTime="+Math.round(Date.now()+a.state.timeOffset)+"&time="+1e3*a.state.videoElement.currentTime).then((function(e){console.log("syncPlay response: "+JSON.stringify(e))}))},e.syncOffset=function(e){this.makeRequest("GET","https://www.handyfeeling.com/api/v1/"+a.state.handyId+"/syncOffset?offset="+e).then((function(e){console.log("syncOffset reponse: "+JSON.stringify(e))}))},e.pauseScript=function(){this.makeRequest("GET","https://www.handyfeeling.com/api/v1/"+a.state.handyId+"/syncPlay?play=false").then((function(e){console.log("syncPlay response: "+JSON.stringify(e))}))},e.makeRequest=function(e,t,n,i){return void 0===n&&(n=null),void 0===i&&(i=!1),new Promise((function(o,a){var r=new XMLHttpRequest;r.open(e,t),r.onload=function(){this.status>=200&&this.status<300?o(JSON.parse(r.response)):a({status:this.status,statusText:r.statusText})},r.onerror=function(){a({status:this.status,statusText:r.statusText})},!0===i&&r.setRequestHeader("Content-Type","multipart/form-data"),r.send(n)}))},e}();t.default=r},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o,a=i(n(3)),r=n(0);o=new a.default(r.state),document.body.appendChild(o.node)},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=n(0),a=i(n(4)),r=i(n(5)),s=i(n(7)),l=i(n(8)),u=i(n(9)),d=function(){function e(e){var t,n=this;this.currentView=null,this.movingWindow=!1,this.mouseStartPosX=0,this.mouseStartPosY=0,this.node=document.createElement("div"),this.node.style.backgroundColor="#000000",this.node.style.position="absolute";var i=document.createElement("button");i.style.right="15px",i.style.position="absolute",i.style.width="15px",i.style.height="100%",i.innerText="=",i.onmousedown=function(e){n.movingWindow=!0,n.mouseStartPosX=e.clientX,n.mouseStartPosY=e.clientY},document.addEventListener("mouseup",(function(e){n.movingWindow=!1})),document.addEventListener("mousemove",(function(e){if(n.movingWindow){n.mouseStartPosX,e.clientX,n.mouseStartPosY,e.clientY;n.node.style.top=e.clientY-50+window.scrollY+"px"}})),this.node.appendChild(i),this.node.style.width="300px",this.node.style.height="185px",this.node.style.top="50vh",this.node.style.zIndex="5000",this.statusText=document.createElement("span"),this.statusText.style.color="#CCCCCC",this.statusText.innerHTML="Select html video element:",this.node.appendChild(this.statusText);var r=document.createElement("button");r.innerHTML=">",r.style.position="absolute",r.style.right="0px",r.style.height="100%",r.style.width="15px";try{null===(t=this.node)||void 0===t||t.animate([{transform:"translate(-285px)"}],{duration:150,iterations:1,fill:"forwards"})}catch(e){this.node.style.left="-285px"}e.hidden=!0,r.onclick=function(t){var i,o;if(e.hidden){r.innerHTML="<";try{null===(o=n.node)||void 0===o||o.animate([{transform:"translate(0px)"}],{duration:150,iterations:1,fill:"forwards"})}catch(e){n.node.style.left="0px"}e.hidden=!0,e.hidden=!1}else{r.innerHTML=">";try{null===(i=n.node)||void 0===i||i.animate([{transform:"translate(-285px)"}],{duration:150,iterations:1,fill:"forwards"})}catch(e){n.node.style.left="-285px"}e.hidden=!0}},this.node.appendChild(r);var s=new a.default(e);this.changeView(s),o.stateChange(o.STATES.SELECT_VIDEO_ELEMENT),this.node=this.node,o.registerStateListener(this)}return e.prototype.onState=function(e,t){var n;if(console.log(e),console.log(t),null===(n=this.currentView)||void 0===n||n.onState(e,t),t.type===o.STATES.SELECT_VIDEO_ELEMENT&&null!==t.videoElement){var i=new r.default(o.state);this.changeView(i),o.stateChange(o.STATES.SELECT_SCRIPT)}if(t.type===o.STATES.UPLOADING_SCRIPT&&e.type!==o.STATES.UPLOADING_SCRIPT){var a=new s.default(o.state,"Uploading script...");this.changeView(a)}if(t.type===o.STATES.INPUT_HANDY_ID&&e.type!==o.STATES.INPUT_HANDY_ID){var d=new u.default(o.state);this.changeView(d)}if(t.type===o.STATES.CONNECTING_HANDY&&e.type!==o.STATES.CONNECTING_HANDY){a=new s.default(o.state,"Connecting to handy");this.changeView(a)}if(t.type===o.STATES.DOWNLOADING_TO_HANDY&&e.type!==o.STATES.DOWNLOADING_TO_HANDY){a=new s.default(o.state,"Downloading script to handy");this.changeView(a)}if(t.type===o.STATES.DETERMINING_DELAY&&e.type!==o.STATES.DETERMINING_DELAY){a=new s.default(o.state,"Determining script latency");this.changeView(a)}if(t.type===o.STATES.READY&&e.type!==o.STATES.READY){var c=new l.default(o.state);this.changeView(c)}this.statusText.innerHTML="VideoElement: "+(void 0!==t.videoElement?"OK":"N/A")+", Script: "+(void 0!==t.script?"OK":"N/A")+", HandyID: "+(void 0!==t.handyId?"OK":"N/A")},e.prototype.changeView=function(e){var t,n;null!=this.currentView&&(console.log("removing previous view"),null===(t=this.node)||void 0===t||t.removeChild(this.currentView.node)),console.log("adding view"),null===(n=this.node)||void 0===n||n.appendChild(e.node),this.currentView=e},e}();t.default=d},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(0),o=function(){function e(e){var t=this;this.videoOverlayList=[],this.videoElementList=[],this.getSupportedMediaPlayers=function(){if(0===t.videoOverlayList.length){var e=document.getElementsByTagName("video");if(0!==e.length)for(var n=function(n){if(null===e[n].offsetParent)return"continue";var o=e[n].getBoundingClientRect(),a=document.createElement("div");a.style.position="absolute",a.style.top=o.top+window.scrollY+"px",a.style.left=o.left+window.scrollX+"px",a.style.width=o.width+"px",a.style.height=o.height+"px",a.style.backgroundColor="#333333",a.style.opacity="0.33",a.style.zIndex="5000",a.onmouseenter=function(e){e.target.style.opacity="0.8",e.target.style.backgroundColor="#333399"},a.onmouseleave=function(e){e.target.style.opacity="0.8",a.style.backgroundColor="#333333"},a.onclick=function(e){for(var n=0;n<t.videoOverlayList.length;n++)t.videoOverlayList[n].parentElement.removeChild(t.videoOverlayList[n]);var o=t.videoElementList[t.videoOverlayList.indexOf(e.target)];i.changeVideoElement(o),t.videoOverlayList=[]},document.body.appendChild(a),t.videoElementList.push(e[n]),t.videoOverlayList.push(a)},o=0;o<e.length;o++)n(o);else alert("found no supported media elements on this site")}};var n=document.createElement("button");n.style.width="70%",n.style.height="60%",n.style.margin="auto",n.innerText="Bind to video element",n.onclick=this.getSupportedMediaPlayers,this.node=document.createElement("div"),this.node.appendChild(n)}return e.prototype.onState=function(e,t){},e}();t.default=o},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=n(0),a=i(n(1)),r=i(n(6)),s=function(){function e(e){this.node=document.createElement("div");var t=document.createElement("input");t.type="file",t.onchange=function(e){console.log(e);var t=e.target.files;a.default.uploadFunscript(t[0]).then((function(e){console.log(e);var t=new r.default(e.url,e.size,e.filename);o.changeScript(t),o.stateChange(o.STATES.INPUT_HANDY_ID)})),o.stateChange(o.STATES.UPLOADING_SCRIPT)},this.node.appendChild(t)}return e.prototype.onState=function(e,t){},e}();t.default=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e,t,n){this.size=0,this.url=e,this.size=t,this.filename=n};t.default=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){this.node=document.createElement("div"),this.node.style.color="#CCCCCC",this.node.innerText=t}return e.prototype.onState=function(e,t){},e}();t.default=i},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=n(0),a=i(n(1)),r=function(){function e(e){var t,n;this.node=document.createElement("div"),this.node.appendChild(document.createElement("br"));var i=document.createElement("span");i.style.color="#CCCCCC",i.innerText="Ready to play script, pause/unpause video",this.node.appendChild(i),this.node.appendChild(document.createElement("br")),this.delay=document.createElement("span"),this.delay.style.color="#CCCCCC",this.delay.innerText="network sync delay: "+e.timeOffset+"  ms",this.node.appendChild(this.delay),this.node.appendChild(document.createElement("br")),this.playTime=document.createElement("span"),this.playTime.style.color="#CCCCCC",this.node.appendChild(this.playTime),this.node.appendChild(document.createElement("br")),this.currentlyPlaying=document.createElement("span"),this.currentlyPlaying.style.color="#CCCCCC",this.currentlyPlaying.innerText="playing: NO",this.node.appendChild(this.currentlyPlaying),setInterval(this.updateTick.bind(this),10),null===(t=e.videoElement)||void 0===t||t.addEventListener("pause",this.onVideoPause),null===(n=e.videoElement)||void 0===n||n.addEventListener("play",this.onVideoPlay)}return e.prototype.onVideoPause=function(e){a.default.pauseScript(),o.changeCurrentlyPlaying(!1)},e.prototype.onVideoPlay=function(e){a.default.playScript(),o.changeCurrentlyPlaying(!0)},e.prototype.updateTick=function(){var e,t;this.playTime.innerHTML="Video location: "+Math.max(Math.round(100*(null!==(t=null===(e=o.state.videoElement)||void 0===e?void 0:e.currentTime)&&void 0!==t?t:0)),1)/100+" s"},e.prototype.onState=function(e,t){this.currentlyPlaying.innerText="playing: "+(t.playing?"YES":"NO")},e}();t.default=r},function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=n(0),a=i(n(1)),r=function(){function e(e){this.node=document.createElement("div");var t=document.createElement("input");t.placeholder="Input handy ID e.g AH5K82";var n=GM_getValue("handyId");null!=n&&(t.value=n);var i=document.createElement("button");i.innerText="Connect",i.onclick=function(e){o.stateChange(o.STATES.CONNECTING_HANDY);var n=t.value;a.default.getStatus(n).then((function(e){console.log(e),!0===e.success&&!0===e.connected?(o.changeHandyIdState(n),GM_setValue("handyId",n),o.stateChange(o.STATES.DOWNLOADING_TO_HANDY),a.default.prepareScriptSync().then((function(e){!0===e.success&&!0===e.downloaded?(o.stateChange(o.STATES.DETERMINING_DELAY),a.default.calculateDelay().then((function(e){o.changeTimeOffset(e),o.stateChange(o.STATES.READY)}))):(alert("error downloading script to handy: "+e.error),o.stateChange(o.STATES.SELECT_SCRIPT))}))):(alert("error connecting to handy: "+e.error),o.stateChange(o.STATES.INPUT_HANDY_ID))}))},this.node.appendChild(t),this.node.appendChild(i)}return e.prototype.onState=function(e,t){},e}();t.default=r}]);